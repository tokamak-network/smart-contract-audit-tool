name: Smart Contract Security Audit

on:
  push:
    paths:
      - '**.sol'
  pull_request:
    paths:
      - '**.sol'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  audit:
    name: Audit Solidity Contracts
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed Solidity files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- '*.sol' | head -20)
          else
            FILES=$(git diff --name-only HEAD~1 HEAD -- '*.sol' 2>/dev/null || git ls-files '*.sol' | head -20)
          fi

          if [ -z "$FILES" ]; then
            echo "No Solidity files changed"
            echo "has_contracts=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_contracts=true" >> $GITHUB_OUTPUT
          echo "Changed contracts:"
          echo "$FILES"
          
          # Save file list for the audit script
          echo "$FILES" > /tmp/changed-sol-files.txt

      - name: Run Security Audit
        if: steps.changed.outputs.has_contracts == 'true'
        id: audit
        env:
          LITELLM_API_KEY: ${{ secrets.LITELLM_API_KEY }}
          LITELLM_BASE_URL: ${{ secrets.LITELLM_BASE_URL || 'https://api.ai.tokamak.network' }}
          LITELLM_MODEL: qwen3-coder-flash
        run: |
          node ${{ github.workspace }}/smart-contract-auditor/scripts/ci-audit.js /tmp/changed-sol-files.txt

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.changed.outputs.has_contracts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('/tmp/audit-report.md', 'utf8');

            // Find and update existing bot comment, or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('ðŸ›¡ï¸ Smart Contract Security Audit')
            );

            const body = `## ðŸ›¡ï¸ Smart Contract Security Audit\n\n` +
              `**Model:** \`qwen3-coder-flash\` via Tokamak Network\n` +
              `**Trigger:** Push to \`${context.ref}\`\n\n` +
              report +
              `\n\n---\n*Automated audit by Tokamak Audit Tool*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Post commit status
        if: github.event_name == 'push' && steps.changed.outputs.has_contracts == 'true'
        run: |
          if [ -f /tmp/audit-report.md ]; then
            echo "## Audit Report" >> $GITHUB_STEP_SUMMARY
            cat /tmp/audit-report.md >> $GITHUB_STEP_SUMMARY
          fi
